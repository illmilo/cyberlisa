{% extends 'agents/agents.html' %}

{% block title %}Servers{% endblock %}
{% block header %}Servers{% endblock %}

{% load static %}

{% block list-header %}Server{% endblock %}
{% block create-header %}Server{% endblock %}

{% block form-groups %}
    <div class="form-group">
        <label for="name">Server Name</label>
        <input type="text" id="name" name="name" placeholder="Enter server name">
    </div>
<!-- 
    <div class="form-group">
        <label for="address">Server Address</label>
        <input type="text" id="address" name="address" placeholder="Enter server address" required>
    </div> -->
<!--     
    <div class="form-group">
        <label for="port">Server Port</label>
        <input type="number" id="port" name="port" placeholder="Enter server port" required>
    </div> -->
    
    <div class="form-group">
        <label for="password">Root Password</label>
        <input type="password" id="password" name="password" placeholder="Enter root password" required>
    </div>

    <div class="form-group">
        <label for="server_key">Server Key</label>
        <input type="text" id="server_key" name="server_key" placeholder="Enter server key (SSH, etc)" required>
    </div>
{% endblock %}

{% block submit-btn %}Create Server{% endblock %}

{% block script %}
    <script src="{% static 'js/dataLoader.js' %}"></script>
    <script src="{% static 'js/listRenderer.js' %}"></script>
    <script src="{% static 'js/dropdownLoader.js' %}"></script>
    <script src="{% static 'js/dataDeleter.js' %}"></script>
    <script src="{% static 'js/dataPoster.js' %}"></script>
    
    <script>
    document.addEventListener('DOMContentLoaded', function() {
    const serverLoader = new DataLoader('http://localhost:8000/servers', 'server');
    const serverRenderer = new ItemRenderer('server', serverLoader, '.list-content');

    const serverDeleter = new DataDeleter(serverLoader, serverRenderer, {
        confirmMessage: 'Delete server {id}?',
        successMessage: 'Server {id} deleted successfully'
    });
    serverDeleter.setupDeletionListener();

    const serverPoster = new DataPoster(
        serverLoader, 
        serverRenderer,
        {
            formId: 'create-form',
            fieldMappings: {
                name: 'name',
                // address: 'ip',  // Map form 'address' to API 'ip'
                // port: 'port',
                password: 'password',
                server_key: 'server_key'
            },
            transformData: (data) => {
                // Convert port to number
                if (data.port) {
                    data.port = parseInt(data.port);
                }
                return data;
            },
            beforeSubmit: (data) => {
                // Validate port range
                if (data.port && (data.port < 1 || data.port > 65535)) {
                    alert('Port must be between 1 and 65535');
                    return false;
                }
                return true;
            }
        }
    );
    serverPoster.initialize();
});
    </script>
{% endblock %}